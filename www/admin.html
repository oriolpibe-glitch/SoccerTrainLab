<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin TrainLab | Tactical Suite v25</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-body: #0a0b0e; 
            --bg-card: #16171d; 
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --text-main: #ffffff; 
            --text-secondary: #94a3b8;
            --pitch-green: #1a472a;
            --pitch-lines: #22c55e;
            --border: rgba(255, 255, 255, 0.1);
            --accent-accept: #10b981;
            --accent-edit: #f59e0b;
            --danger: #ef4444;
        }
        
        body { 
            margin: 0; 
            font-family: 'Outfit', sans-serif; 
            background: var(--bg-body); 
            color: var(--text-main); 
            overflow-x: hidden; 
        }
        
        header { 
            padding: 15px 30px; 
            background: rgba(15, 17, 23, 0.9); 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            backdrop-filter: blur(20px);
        }
        
        .container { 
            max-width: 1000px; 
            margin: 30px auto; 
            padding: 0 20px; 
        }
        
        .card { 
            background: var(--bg-card); 
            padding: 20px; 
            border-radius: 16px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border: 1px solid var(--border); 
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.1);
        }

        .actions-gap { 
            display: flex; 
            gap: 8px; 
            align-items: center; 
        }
        
        .btn-base { 
            border: none; 
            padding: 10px 18px; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.85rem; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            transition: 0.2s; 
        }
        
        .btn-base:hover {
            transform: translateY(-2px);
        }
        
        .btn-base:active { 
            transform: scale(0.95); 
        }

        .btn-view { 
            background: var(--primary); 
            color: white; 
        }
        
        .btn-accept { 
            background: var(--accent-accept); 
            color: white; 
        }
        
        .btn-edit { 
            background: var(--accent-edit); 
            color: #000; 
        }
        
        .btn-del { 
            background: rgba(239, 68, 68, 0.1); 
            color: var(--danger); 
            border: 1px solid var(--danger); 
            padding: 10px 14px; 
        }

        #user-info { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        
        #user-display { 
            font-size: 0.8rem; 
            color: var(--text-secondary); 
            font-weight: 400; 
        }
        
        .btn-logout { 
            background: rgba(255, 255, 255, 0.1); 
            color: white; 
            border: 1px solid var(--border); 
            padding: 6px 12px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 0.75rem; 
            font-weight: 600; 
            transition: 0.2s; 
        }
        
        .btn-logout:hover { 
            background: rgba(255, 255, 255, 0.2); 
        }

        #modal { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.98); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
            padding: 20px; 
            backdrop-filter: blur(10px);
        }
        
        .modal-box { 
            background: var(--bg-card); 
            padding: 20px; 
            border-radius: 20px; 
            width: 100%; 
            max-width: 950px; 
            position: relative; 
            border: 1px solid var(--border); 
            max-height: 90vh; 
            overflow-y: auto; 
        }
        
        /* PITCH CONTAINER - IGUAL QUE CREAR_EJERCICIO */
        #pitch-container { 
            position: relative; 
            background: linear-gradient(135deg, var(--pitch-green) 0%, #1a472a 100%); 
            width: 100%; 
            border: 4px solid rgba(255, 255, 255, 0.9); 
            overflow: hidden; 
            margin: 0 auto; 
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .pitch-lines-layer { 
            position: absolute; 
            inset: 0; 
            pointer-events: none; 
            z-index: 1; 
        }
        
        .line-white { 
            position: absolute; 
            border: 3px solid var(--pitch-lines); 
            pointer-events: none; 
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
        }
        
        canvas { 
            position: absolute; 
            inset: 0; 
            z-index: 5; 
            pointer-events: none; 
        }
        
        #obj-layer { 
            position: absolute; 
            inset: 0; 
            z-index: 10; 
            pointer-events: none; 
        }
        
        /* ELEMENTS - IGUAL QUE CREAR_EJERCICIO */
        .element { 
            position: absolute; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transform-origin: center center; 
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }
        
        .player { 
            width: 42px; 
            height: 42px; 
            border-radius: 50%; 
            border: 3px solid white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 800; 
            color: white; 
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .cone-obj { 
            width: 0; 
            height: 0; 
            border-left: 16px solid transparent; 
            border-right: 16px solid transparent; 
            border-bottom: 28px solid #f59e0b; 
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .goal-visual {
            width: 70px;
            height: 40px;
            border: 3px solid #ef4444;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .ladder-body {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border-left: 3px solid currentColor;
            border-right: 3px solid currentColor;
            position: relative;
        }

        .ladder-step-line {
            height: 3px;
            background: currentColor;
            width: 100%;
            border-radius: 1px;
        }
        
        .close-btn { 
            position: absolute; 
            top: -15px; 
            right: -15px; 
            background: var(--primary); 
            border: none; 
            color: white; 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            font-size: 1.5rem; 
            cursor: pointer; 
            z-index: 1100; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: 0.3s;
        }
        
        .close-btn:hover {
            background: var(--primary-dark);
            transform: rotate(90deg);
        }
        
        .category-select {
            background: rgba(255, 255, 255, 0.05); 
            color: white; 
            border: 1px solid var(--border);
            padding: 10px; 
            border-radius: 10px; 
            width: 100%; 
            margin: 10px 0;
            font-family: 'Outfit'; 
            outline: none;
            font-size: 0.9rem;
        }
        
        .category-select:focus {
            border-color: var(--primary);
        }
        
        /* Badges d'estat */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .status-accepted {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .modal-details {
            margin-top: 25px;
            color: var(--text-main);
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        
        .modal-details h2 {
            margin: 0 0 15px 0;
            color: var(--primary-light);
            font-size: 1.8rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .modal-details p {
            color: var(--text-secondary);
            line-height: 1.7;
            font-size: 1.05rem;
            margin: 0;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            header {
                padding: 10px 20px;
            }
            
            .container {
                padding: 0 15px;
            }
            
            .card {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .actions-gap {
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
            }
            
            .modal-box {
                padding: 15px;
            }
            
            .close-btn {
                top: 10px;
                right: 10px;
            }
        }
        
        /* Afegit: Responsive per a mòbil - millores addicionals */
        @media (max-width: 768px) {
            header {
                padding: 10px 15px;
                flex-direction: column;
                gap: 12px;
            }
            
            #user-info {
                width: 100%;
                justify-content: flex-end;
                margin-top: 5px;
            }
            
            .container {
                margin: 15px auto;
                padding: 0 12px;
            }
            
            .card {
                padding: 15px;
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
                margin-bottom: 10px;
            }
            
            .actions-gap {
                width: 100%;
                justify-content: space-between;
                flex-wrap: nowrap;
                gap: 5px;
            }
            
            .btn-base {
                padding: 10px 12px;
                font-size: 0.75rem;
                flex: 1;
                justify-content: center;
                min-width: 0;
            }
            
            .btn-base i {
                margin-right: 4px;
            }
            
            .modal-box {
                padding: 10px;
                margin: 10px;
                max-height: 85vh;
            }
            
            .close-btn {
                top: 5px;
                right: 5px;
                width: 35px;
                height: 35px;
                font-size: 1.3rem;
            }
            
            #pitch-container {
                min-height: 250px;
            }
            
            .modal-details {
                padding: 15px;
                margin-top: 15px;
            }
            
            .modal-details h2 {
                font-size: 1.3rem;
                margin-bottom: 10px;
            }
            
            .modal-details p {
                font-size: 0.9rem;
            }
            
            .category-select {
                font-size: 0.85rem;
                padding: 8px;
            }
            
            .modal-details > div:last-child {
                flex-direction: column;
                gap: 8px;
            }
            
            .modal-details > div:last-child button {
                width: 100%;
                justify-content: center;
            }
            
            /* Millores per a pantalles molt petites */
            @media (max-width: 480px) {
                .container {
                    padding: 0 8px;
                }
                
                .card > div:first-child {
                    width: 100%;
                }
                
                .status-badge {
                    align-self: flex-start;
                    margin-top: 5px;
                }
                
                .btn-base span {
                    display: none;
                }
                
                .btn-base i {
                    margin-right: 0;
                    font-size: 1rem;
                }
                
                .btn-base {
                    padding: 10px;
                    min-width: 40px;
                    flex: 0 0 auto;
                }
                
                .btn-base.btn-del {
                    flex: 0 0 auto;
                }
                
                .btn-base.btn-view, 
                .btn-base.btn-accept {
                    flex: 1;
                }
                
                .btn-base.btn-view span,
                .btn-base.btn-accept span {
                    display: inline;
                }
            }
        }

        /* Afegit: Millores per a orientació vertical en mòbil */
        @media (max-width: 768px) and (orientation: portrait) {
            .modal-box {
                width: 95%;
                max-height: 90vh;
            }
            
            #pitch-container {
                aspect-ratio: 1.2 / 1 !important;
            }
        }

        /* Afegit: Suport per a pantalla tàctil */
        @media (hover: none) and (pointer: coarse) {
            .btn-base:hover {
                transform: none;
            }
            
            .btn-base:active {
                transform: scale(0.95);
            }
            
            .close-btn:hover {
                transform: none;
            }
            
            .close-btn:active {
                transform: rotate(90deg);
            }
        }

        /* Afegit: Millores d'accessibilitat per a mòbil */
        @media (max-width: 768px) {
            .btn-base,
            .btn-logout,
            .close-btn {
                min-height: 44px; /* Mida mínima recomanada per a punts tàctils */
            }
            
            select {
                font-size: 16px; /* Evita el zoom automàtic en iOS */
            }
            
            /* Assegurar que el text sigui llegible */
            body {
                -webkit-text-size-adjust: 100%;
                text-size-adjust: 100%;
            }
        }
    </style>
</head>
<body>

    <header>
        <div style="font-weight:800; font-size:1.6rem; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); -webkit-background-clip: text; background-clip: text; color: transparent;">
            TRAINLAB <span style="font-weight:400; color: var(--text-secondary);">ADMIN</span>
        </div>
        <div id="user-info">
            <span id="user-display">Verificant...</span>
            <button class="btn-logout" onclick="logout()">SORTIR</button>
        </div>
    </header>

    <div class="container">
        <div id="exercise-list"></div>
    </div>

    <div id="modal">
        <div class="modal-box">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            <div id="pitch-container">
                <div id="lines-layer" class="pitch-lines-layer"></div>
                <canvas id="mainCanvas"></canvas>
                <div id="obj-layer"></div>
            </div>
            
            <div class="modal-details">
                <h2 id="modal-title"></h2>
                <p id="modal-notes"></p>
                
                <div style="margin-top: 20px;">
                    <label style="font-size:0.8rem; color:var(--text-secondary); font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">CATEGORIA</label>
                    <select id="modal-category-select" class="category-select">
                        <option value="Escalfament">Escalfament</option>
                        <option value="Posessió">Posessió</option>
                        <option value="Finalització">Finalització</option>
                        <option value="Estratègia">Estratègia</option>
                        <option value="Roda de Passes">Roda de Passes</option>
                        <option value="Defensa">Defensa</option>
                        <option value="Transició">Transició</option>
                    </select>
                </div>
                
                <div style="margin-top:20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn-base btn-accept" onclick="acceptFromModal()">
                        <i class="fas fa-check"></i> ACCEPTAR I TANCAR
                    </button>
                    <button class="btn-base btn-edit" onclick="editDataFromModal()">
                        <i class="fas fa-edit"></i> EDITAR TÍTOL/NOTES
                    </button>
                    <button class="btn-base btn-del" onclick="deleteFromModal()">
                        <i class="fas fa-trash"></i> ELIMINAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, getDoc, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBBaxLhVUekJLCyrtvQaF7t_-1dTERbvAE",
            authDomain: "soccertrainlab.firebaseapp.com",
            projectId: "soccertrainlab",
            storageBucket: "soccertrainlab.firebasestorage.app",
            messagingSenderId: "681099221197",
            appId: "1:681099221197:web:55ae8621c8bc8649057184"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentId = null;

        const ADMIN_EMAILS = ["pibeoriol@gmail.com"];

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "login.html";
            } else if (!ADMIN_EMAILS.includes(user.email)) {
                alert("Accés denegat: No ets administrador.");
                signOut(auth);
            } else {
                document.getElementById('user-display').innerText = user.email;
                startApp();
            }
        });

        window.logout = () => {
            signOut(auth).then(() => window.location.href = "login.html");
        };

        function startApp() {
            const q = query(
                collection(db, "exercicis"), 
                orderBy("estat", "desc"), 
                orderBy("timestamp", "desc")
            );

            onSnapshot(q, (snaps) => {
                const list = document.getElementById('exercise-list');
                list.innerHTML = '';
                
                if (snaps.empty) {
                    list.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                            <i class="fas fa-clipboard-list" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i>
                            <h3 style="color: var(--text-main); margin-bottom: 10px;">No hi ha exercicis pendents</h3>
                            <p>Tots els exercicis estan revisats</p>
                        </div>
                    `;
                    return;
                }
                
                snaps.forEach(s => {
                    const d = s.data();
                    const card = document.createElement('div');
                    card.className = 'card';
                    const estatActual = d.estat || 'pendent';
                    const isAccepted = estatActual === 'acceptat';
                    
                    // Utilitzem 'tipus' que és el camp que envia el dissenyador
                    const categoriaMostrar = d.tipus || "Escalfament";

                    const dateDisplay = d.timestamp?.seconds 
                        ? new Date(d.timestamp.seconds * 1000).toLocaleDateString('ca-ES') + ' ' + 
                          new Date(d.timestamp.seconds * 1000).toLocaleTimeString('ca-ES', {hour: '2-digit', minute:'2-digit'})
                        : (d.timestamp ? new Date(d.timestamp).toLocaleDateString('ca-ES') : '');

                    card.innerHTML = `
                        <div style="flex: 1; opacity: ${isAccepted ? '0.7' : '1'}"> 
                            <div style="font-weight:800; color:var(--text-main); font-size:1.1rem; margin-bottom: 6px;">
                                ${d.title || 'Sense Títol'}
                            </div>
                            <div style="font-size:0.75rem; color:var(--text-secondary); margin-bottom: 8px;">
                                <span><i class="fas fa-calendar"></i> ${dateDisplay}</span> 
                                <span style="margin: 0 10px">|</span>
                                <span><i class="fas fa-tag"></i> ${categoriaMostrar}</span>
                            </div>
                            <div class="status-badge ${isAccepted ? 'status-accepted' : 'status-pending'}">
                                ${isAccepted ? 'ACCEPTAT' : 'PENDENT'}
                            </div>
                        </div>
                        <div class="actions-gap">
                            <button class="btn-base btn-view" onclick="openEx('${s.id}')">
                                <i class="fas fa-eye"></i> VEURE
                            </button>
                            ${!isAccepted ? `
                                <button class="btn-base btn-accept" onclick="openEx('${s.id}')">
                                    <i class="fas fa-check"></i> REVISAR
                                </button>
                            ` : ''}
                            <button class="btn-base btn-del" onclick="deleteEx('${s.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>`;
                    list.appendChild(card);
                });
            });
        }

        window.acceptEx = async (id) => {
            const selector = document.getElementById('modal-category-select');
            // Important: Guardem com a 'tipus' per mantenir coherència amb el dissenyador
            const categoryToSave = selector ? selector.value : "Escalfament";

            try {
                const exerciciRef = doc(db, "exercicis", id);
                await updateDoc(exerciciRef, {
                    estat: "acceptat",
                    tipus: categoryToSave 
                });
                alert("✅ Exercici acceptat!");
                closeModal();
            } catch (e) {
                console.error("Error:", e);
                alert("No s'ha pogut acceptar.");
            }
        };

        window.acceptFromModal = () => { 
            if(currentId) window.acceptEx(currentId); 
        };

        window.editDataFromModal = async () => {
            if(!currentId) return;
            const snap = await getDoc(doc(db, "exercicis", currentId));
            const oldData = snap.data();
            const newTitle = prompt("Nou títol de l'exercici:", oldData.title || "");
            const newNotes = prompt("Noves notes/descripció:", oldData.notes || "");
            if(newTitle !== null) {
                try {
                    await updateDoc(doc(db, "exercicis", currentId), { 
                        title: newTitle, 
                        notes: newNotes 
                    });
                    alert("Dades actualitzades!");
                    openEx(currentId); // Recarregar per veure canvis
                } catch (e) { 
                    alert("Error al guardar."); 
                }
            }
        };

        window.deleteFromModal = async () => {
            if(!currentId) return;
            if(confirm("Segur que vols eliminar permanentment aquest exercici?")) {
                try {
                    await deleteDoc(doc(db, "exercicis", currentId));
                    alert("Exercici eliminat!");
                    closeModal();
                } catch (e) {
                    alert("Error eliminant l'exercici.");
                }
            }
        };

        window.openEx = async (id) => {
            currentId = id;
            const snap = await getDoc(doc(db, "exercicis", id));
            const data = snap.data();
            const container = document.getElementById('pitch-container');
            const objLayer = document.getElementById('obj-layer');
            const canvas = document.getElementById('mainCanvas');
            const ctx = canvas.getContext('2d');
            
            document.getElementById('modal').style.display = 'flex';
            
            // Actualitzar títol i notes al modal
            document.getElementById('modal-title').innerText = data.title || "SENSE TÍTOL";
            document.getElementById('modal-notes').innerText = data.notes || "Sense notes.";
            
            // Configurar categoria al selector
            const catActual = data.tipus || "Escalfament";
            const selector = document.getElementById('modal-category-select');
            if (selector) {
                selector.value = catActual;
            }

            // Configurar aspect ratio igual que crear_ejercicio
            if (data.isFullPitch !== undefined) {
                container.style.aspectRatio = data.isFullPitch ? "1.5 / 1" : "1.2 / 1";
            } else {
                container.style.aspectRatio = "1.2 / 1";
            }

            // Esperar a que el container tingui dimensions
            setTimeout(() => {
                const W = container.clientWidth; 
                const H = container.clientHeight;
                canvas.width = W; 
                canvas.height = H;
                objLayer.innerHTML = '';
                
                // Renderitzar línies del camp
                renderPitchLines(data.isFullPitch || false);
                
                // IMPORTANT: Renderitzar paths amb percentatges (igual que crear_ejercicio)
                if(data.paths && data.paths.length > 0) {
                    data.paths.forEach(p => {
                        // Convertir percentatges a píxels
                        const x1 = (p.x1 * W) / 100;
                        const y1 = (p.y1 * H) / 100;
                        const x2 = (p.x2 * W) / 100;
                        const y2 = (p.y2 * H) / 100;
                        const color = p.color || "rgba(255, 255, 255, 0.9)";
                        
                        drawArrow(ctx, x1, y1, x2, y2, p.dash, color);
                    });
                }
                
                // IMPORTANT: Renderitzar objectes amb percentatges (igual que crear_ejercicio)
                if(data.objects && data.objects.length > 0) {
                    data.objects.forEach(o => {
                        const el = document.createElement('div');
                        el.className = 'element';
                        
                        // Percentatges directes (0-100%)
                        el.style.left = o.x + "%"; 
                        el.style.top = o.y + "%";
                        
                        // Aplicar transformació
                        el.style.transform = `translate(-50%, -50%) rotate(${o.rot || 0}deg) scale(${o.scale || 1})`;
                        
                        // Tipus d'objecte (IGUAL QUE CREAR_EJERCICIO)
                        if(o.type && o.type.startsWith('p-')) {
                            const col = o.color || (o.type === 'p-red' ? '#ef4444' : 
                                       o.type === 'p-blue' ? '#3b82f6' : 
                                       o.type === 'p-yellow' ? '#f59e0b' : '#8b5cf6');
                            el.innerHTML = `<div class="player" style="background:${col}">${o.text || ''}</div>`;
                        } 
                        else if(o.type === 'cone') {
                            el.innerHTML = `<div class="cone-obj" style="border-bottom-color:${o.color || '#f59e0b'}"></div>`;
                        } 
                        else if(o.type === 'ball') {
                            el.innerHTML = `<i class="fas fa-futbol" style="color:white; font-size:26px;"></i>`;
                        } 
                        else if(o.type === 'goal') {
                            el.innerHTML = `<div class="goal-visual" style="border-color:${o.color || '#ef4444'}"></div>`;
                        } 
                        else if(o.type === 'ladder') {
                            const height = o.h || "100px";
                            const stepsCount = Math.max(2, Math.floor(parseInt(height) / 25));
                            let stepsHtml = '';
                            for(let i = 0; i <= stepsCount; i++) {
                                stepsHtml += `<div class="ladder-step-line"></div>`;
                            }
                            el.innerHTML = `
                                <div class="ladder-body" style="width:35px; height:${height}; color:${o.color || '#ffffff'}">
                                    ${stepsHtml}
                                </div>
                            `;
                        }
                        else if(o.type === 'valla') {
                            el.innerHTML = `<div style="width:45px; height:8px; border:2px solid ${o.color || '#ffffff'}"></div>`;
                        }
                        
                        objLayer.appendChild(el);
                    });
                }
            }, 100);
        };

        window.deleteEx = async (id) => {
            if(confirm("Segur que vols eliminar permanentment aquest exercici?")) {
                try {
                    await deleteDoc(doc(db, "exercicis", id));
                    alert("Exercici eliminat!");
                } catch (e) {
                    alert("Error eliminant l'exercici.");
                }
            }
        };

        // Funció per dibuixar fletxes (IGUAL QUE CREAR_EJERCICIO)
        function drawArrow(c, x1, y1, x2, y2, dash, color) {
            c.beginPath(); 
            c.lineWidth = 5; 
            c.strokeStyle = color || "rgba(255, 255, 255, 0.9)";
            if(dash) c.setLineDash([12, 8]); 
            else c.setLineDash([]);
            c.moveTo(x1, y1); 
            c.lineTo(x2, y2); 
            c.stroke();
            
            const angle = Math.atan2(y2-y1, x2-x1);
            c.setLineDash([]); 
            c.beginPath(); 
            c.moveTo(x2, y2);
            c.lineTo(x2-18*Math.cos(angle-0.5), y2-18*Math.sin(angle-0.5));
            c.lineTo(x2-18*Math.cos(angle+0.5), y2-18*Math.sin(angle+0.5));
            c.closePath(); 
            c.fillStyle = color || "rgba(255, 255, 255, 0.9)"; 
            c.fill();
        }

        // Funció per renderitzar línies del camp
        function renderPitchLines(isFull) {
            const linesLayer = document.getElementById('lines-layer');
            const container = document.getElementById('pitch-container');
            linesLayer.innerHTML = '';
            
            if (!isFull) {
                container.style.border = "4px solid rgba(255, 255, 255, 0.9)";
                return; 
            }
            
            container.style.border = "4px solid rgba(255, 255, 255, 0.9)";
            const c = "rgba(34, 197, 94, 0.95)";
            const h = container.clientHeight;
            
            let html = `
                <div class="line-white" style="left:0; top:20%; width:16%; height:60%; border-left:none; box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);"></div>
                <div class="line-white" style="right:0; top:20%; width:16%; height:60%; border-right:none; box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);"></div>
                <div class="line-white" style="left:0; top:35%; width:6%; height:30%; border-left:none; box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);"></div>
                <div class="line-white" style="right:0; top:35%; width:6%; height:30%; border-right:none; box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);"></div>
                <div style="position:absolute; left:50%; top:0; width:4px; height:100%; background:${c}; transform:translateX(-50%); box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);"></div>
                <div style="position:absolute; left:50%; top:50%; width:${h*0.3}px; height:${h*0.3}px; border:4px solid ${c}; border-radius:50%; transform:translate(-50%,-50%); box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);"></div>
                <div style="position:absolute; left:50%; top:50%; width:${h*0.05}px; height:${h*0.05}px; background:${c}; border-radius:50%; transform:translate(-50%,-50%); box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);"></div>
            `;
            linesLayer.innerHTML = html;
        }

        window.closeModal = () => { 
            document.getElementById('modal').style.display = 'none'; 
        };
    </script>
</body>
</html>