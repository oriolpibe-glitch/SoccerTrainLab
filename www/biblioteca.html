<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca TrainLab | Tactical Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-body: #0f1117; 
            --bg-card: #1a1d28; 
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --text-main: #f8fafc; 
            --text-secondary: #94a3b8;
            --pitch-green: #1a472a;
            --pitch-lines: #22c55e;
            --border: rgba(255, 255, 255, 0.08);
            --shadow: rgba(0, 0, 0, 0.3);
            --radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --success: #10b981;
            --success-light: #34d399;
            --warning: #f59e0b;
        }

        body { 
            margin: 0; 
            font-family: 'Outfit', sans-serif; 
            background: var(--bg-body); 
            color: var(--text-main);
            min-height: 100vh;
        }

        /* CAPÇALERA PREMIUM */
        header { 
            padding: 0 30px; 
            background: rgba(15, 17, 23, 0.9); 
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex; 
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
            height: 70px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }

        .back-link {
            text-decoration: none; 
            color: var(--text-secondary); 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            font-weight: 600; 
            font-size: 0.85rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: var(--transition);
            padding: 12px 20px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .back-link:hover {
            color: var(--primary-light);
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.2);
            transform: translateX(-5px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.1);
        }

        .logo-text {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 800; 
            font-size: 1.4rem;
            letter-spacing: 3px;
            text-align: center;
            white-space: nowrap;
            pointer-events: none;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 10px rgba(99, 102, 241, 0.2);
        }

        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-badge {
            padding: 10px 18px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 10px;
            font-size: 0.85rem;
            color: var(--primary-light);
            border: 1px solid rgba(99, 102, 241, 0.2);
            font-weight: 600;
            display: none;
        }

        .personal-library-btn {
            padding: 10px 18px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 10px;
            font-size: 0.85rem;
            color: var(--success-light);
            border: 1px solid rgba(16, 185, 129, 0.2);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: none;
        }

        .personal-library-btn:hover {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.1);
        }

        /* CONTROLS I FILTRES ELEGANTS */
        .container { 
            max-width: 1400px; 
            margin: 40px auto; 
            padding: 0 30px; 
        }
        
        .controls { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 30px; 
            margin-bottom: 50px; 
        }
        
        .search-wrapper { 
            position: relative; 
            width: 100%; 
            max-width: 600px; 
        }
        
        .search-wrapper i { 
            position: absolute; 
            left: 22px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--text-secondary); 
            font-size: 1.2rem; 
            z-index: 2;
        }
        
        .search-bar { 
            background: var(--bg-card); 
            border: 2px solid var(--border); 
            padding: 18px 20px 18px 60px; 
            border-radius: 14px; 
            color: var(--text-main); 
            width: 100%; 
            outline: none; 
            font-size: 1rem; 
            transition: var(--transition);
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .search-bar:focus { 
            border-color: var(--primary); 
            background: #222633; 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.2);
        }

        .search-bar::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .tags-container { 
            display: flex; 
            gap: 12px; 
            justify-content: center; 
            flex-wrap: wrap; 
        }
        
        .tag { 
            background: var(--bg-card); 
            border: 1px solid var(--border); 
            padding: 12px 24px; 
            border-radius: 30px; 
            cursor: pointer; 
            font-size: 0.9rem; 
            font-weight: 600; 
            transition: var(--transition); 
            color: var(--text-secondary);
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .tag:hover { 
            border-color: var(--primary); 
            color: var(--text-main); 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.15);
        }
        
        .tag.active { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); 
            color: white; 
            border-color: var(--primary);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3);
        }

        /* GRID MODERN */
        #library-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); 
            gap: 25px; 
        }
        
        .ex-card { 
            background: var(--bg-card); 
            border-radius: var(--radius); 
            border: 1px solid var(--border); 
            overflow: hidden; 
            transition: var(--transition); 
            cursor: pointer; 
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .ex-card:hover { 
            transform: translateY(-8px); 
            border-color: var(--primary);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 0 1px var(--primary);
        }
        
        .ex-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            opacity: 0;
            transition: var(--transition);
        }
        
        .ex-card:hover::before {
            opacity: 1;
        }
        
        .ex-preview { 
            background: linear-gradient(135deg, var(--pitch-green) 0%, #14532d 100%); 
            height: 180px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative;
            overflow: hidden;
        }
        
        .ex-preview::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(34, 197, 94, 0.1) 50%, transparent 70%);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .ex-preview i { 
            font-size: 3.5rem; 
            opacity: 0.3; 
            color: white; 
            z-index: 1;
        }
        
        .ex-content { 
            padding: 20px; 
        }
        
        .ex-title { 
            font-weight: 800; 
            font-size: 1.2rem; 
            margin-bottom: 8px; 
            color: var(--text-main); 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1.3;
        }
        
        .ex-info { 
            font-size: 0.9rem; 
            color: var(--text-secondary); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 15px;
        }
        
        .ex-category {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary-light);
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        
        .ex-date {
            font-weight: 500;
        }

        .ex-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .add-to-library-btn {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
        }

        .add-to-library-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }

        .add-to-library-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .added-badge {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-light);
            padding: 10px 18px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        /* MODAL PREMIUM */
        #modal { 
            position: fixed; 
            inset: 0; 
            background: rgba(0, 0, 0, 0.95); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 10000; 
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        .modal-box { 
            background: var(--bg-card); 
            padding: 30px; 
            border-radius: 24px; 
            width: 100%; 
            max-width: 1000px; 
            position: relative; 
            border: 1px solid var(--border);
            max-height: 90vh; 
            overflow-y: auto;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
        }
        
        .close-btn { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            background: var(--primary); 
            border: none; 
            color: white; 
            width: 44px; 
            height: 44px; 
            border-radius: 50%; 
            font-size: 1.6rem; 
            cursor: pointer; 
            z-index: 11000; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: var(--transition);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
        }
        
        .close-btn:hover {
            background: var(--primary-dark);
            transform: rotate(90deg);
            box-shadow: 0 6px 25px rgba(99, 102, 241, 0.4);
        }

        /* PITCH DINS MODAL - IGUAL QUE CREAR_EJERCICIO */
        #pitch-container { 
            position: relative; 
            background: linear-gradient(135deg, var(--pitch-green) 0%, #1a472a 100%); 
            width: 100%; 
            border: 4px solid rgba(255, 255, 255, 0.9); 
            overflow: hidden; 
            margin: 0 auto;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .pitch-lines-layer { 
            position: absolute; 
            inset: 0; 
            pointer-events: none; 
            z-index: 1; 
        }
        
        .line-white { 
            position: absolute; 
            border: 3px solid var(--pitch-lines); 
            pointer-events: none; 
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
        }
        
        canvas { 
            position: absolute; 
            inset: 0; 
            z-index: 5; 
            pointer-events: none; 
        }
        
        #obj-layer { 
            position: absolute; 
            inset: 0; 
            z-index: 10; 
            pointer-events: none; 
        }
        
        .element { 
            position: absolute; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transform-origin: center center; 
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }
        
        .player { 
            width: 42px; 
            height: 42px; 
            border-radius: 50%; 
            border: 3px solid white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 800; 
            color: white; 
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .cone-obj { 
            width: 0; 
            height: 0; 
            border-left: 16px solid transparent; 
            border-right: 16px solid transparent; 
            border-bottom: 28px solid #f59e0b; 
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .goal-visual {
            width: 70px;
            height: 40px;
            border: 3px solid #ef4444;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .ladder-body {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border-left: 3px solid currentColor;
            border-right: 3px solid currentColor;
            position: relative;
        }

        .ladder-step-line {
            height: 3px;
            background: currentColor;
            width: 100%;
            border-radius: 1px;
        }

        .modal-details {
            margin-top: 25px;
            color: var(--text-main);
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .modal-details h2 {
            margin: 0 0 15px 0;
            color: var(--primary-light);
            font-size: 1.8rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .modal-details p {
            color: var(--text-secondary);
            line-height: 1.7;
            font-size: 1.05rem;
            margin: 0;
        }

        /* TOAST NOTIFICATIONS */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--bg-card);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast i {
            font-size: 1.2rem;
        }

        .toast.success i {
            color: var(--success-light);
        }

        .toast.error i {
            color: #ef4444;
        }

        /* SCROLLBAR PERSONALITZADA */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }

        /* RESPONSIVE BÀSIC */
        @media (max-width: 768px) {
            header {
                padding: 0 20px;
                height: 60px;
            }
            
            .logo-text {
                font-size: 1.1rem;
                letter-spacing: 2px;
            }
            
            .back-link {
                padding: 10px 16px;
                font-size: 0.75rem;
            }
            
            .user-badge, .personal-library-btn {
                padding: 8px 14px;
                font-size: 0.75rem;
            }
            
            .container {
                padding: 0 20px;
                margin: 30px auto;
            }
            
            .search-bar {
                padding: 16px 16px 16px 50px;
            }
            
            #library-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .modal-box {
                padding: 20px;
            }
            
            .ex-actions {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }

        /* AFEGEIX AQUESTS ESTILS AL FINAL */
        /* Estils per a mòbils petits (max-width: 480px) */
        @media (max-width: 480px) {
            header {
                padding: 0 15px;
                height: 55px;
            }
            
            .logo-text {
                font-size: 0.95rem;
                letter-spacing: 1.5px;
                position: relative;
                left: 0;
                transform: none;
                margin: 0 auto;
                width: fit-content;
            }
            
            .back-link {
                padding: 8px 12px;
                font-size: 0.7rem;
                gap: 6px;
                position: relative;
                z-index: 2;
            }
            
            .back-link i {
                font-size: 0.8rem;
            }
            
            .header-right {
                gap: 8px;
            }
            
            .user-badge, .personal-library-btn {
                padding: 6px 10px;
                font-size: 0.7rem;
                border-radius: 8px;
            }
            
            .container {
                padding: 0 15px;
                margin: 15px auto;
            }
            
            .controls {
                gap: 20px;
                margin-bottom: 30px;
            }
            
            .search-bar {
                padding: 14px 14px 14px 45px;
                font-size: 0.9rem;
                border-radius: 12px;
            }
            
            .search-wrapper i {
                left: 18px;
                font-size: 1rem;
            }
            
            .tags-container {
                gap: 8px;
            }
            
            .tag {
                padding: 8px 16px;
                font-size: 0.8rem;
                border-radius: 25px;
            }
            
            #library-grid {
                gap: 15px;
            }
            
            .ex-card {
                min-width: 0;
                margin: 0;
            }
            
            .ex-preview {
                height: 140px;
            }
            
            .ex-preview i {
                font-size: 2.5rem;
            }
            
            .ex-content {
                padding: 15px;
            }
            
            .ex-title {
                font-size: 1rem;
                margin-bottom: 6px;
            }
            
            .ex-info {
                font-size: 0.8rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                margin-bottom: 12px;
            }
            
            .ex-category {
                padding: 4px 10px;
                font-size: 0.75rem;
            }
            
            .ex-actions {
                flex-direction: row;
                gap: 10px;
                padding-top: 12px;
            }
            
            .view-btn,
            .add-to-library-btn,
            .added-badge {
                padding: 8px 12px;
                font-size: 0.8rem;
                width: 100%;
                justify-content: center;
                border-radius: 8px;
            }
            
            .view-btn i,
            .add-to-library-btn i,
            .added-badge i {
                font-size: 0.85rem;
            }
            
            /* Modal adjustments for mobile */
            #modal {
                padding: 10px;
                align-items: flex-start;
                padding-top: 60px;
            }
            
            .modal-box {
                padding: 20px 15px;
                border-radius: 16px;
                max-height: 80vh;
                width: 95%;
            }
            
            .close-btn {
                width: 36px;
                height: 36px;
                font-size: 1.4rem;
                top: 10px;
                right: 10px;
            }
            
            .modal-details {
                padding: 15px;
                margin-top: 15px;
            }
            
            .modal-details h2 {
                font-size: 1.3rem;
                margin-bottom: 10px;
            }
            
            .modal-details p {
                font-size: 0.9rem;
                line-height: 1.5;
            }
            
            /* Pitch container adjustments */
            #pitch-container {
                border-width: 2px;
            }
            
            /* Toast adjustments */
            .toast {
                left: 15px;
                right: 15px;
                bottom: 15px;
                width: auto;
            }
            
            /* Empty library state */
            .empty-library {
                padding: 40px 15px;
            }
            
            .empty-library i {
                font-size: 3rem;
                margin-bottom: 15px;
            }
            
            .empty-library h3 {
                font-size: 1.2rem;
            }
            
            .empty-library p {
                font-size: 0.9rem;
            }
        }

        /* Millores per a tablets (481px a 768px) */
        @media (min-width: 481px) and (max-width: 768px) {
            #library-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
            
            .ex-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .view-btn,
            .add-to-library-btn,
            .added-badge {
                width: 100%;
                justify-content: center;
            }
        }

        /* Millores per a orientació landscape en mòbils */
        @media (max-height: 600px) and (max-width: 900px) {
            .modal-box {
                max-height: 85vh;
                overflow-y: auto;
            }
            
            #pitch-container {
                max-height: 50vh;
            }
        }

        /* Suport per a dispositius amb notch o areas segures */
        @supports (padding: max(0px)) {
            header {
                padding-left: max(15px, env(safe-area-inset-left));
                padding-right: max(15px, env(safe-area-inset-right));
            }
            
            .container {
                padding-left: max(15px, env(safe-area-inset-left));
                padding-right: max(15px, env(safe-area-inset-right));
            }
            
            #modal {
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Millores d'accessibilitat per a touch */
        @media (hover: none) and (pointer: coarse) {
            .ex-card:hover {
                transform: none;
            }
            
            .view-btn,
            .add-to-library-btn,
            .added-badge,
            .back-link,
            .close-btn,
            .tag {
                min-height: 44px; /* Minimum touch target size */
            }
            
            .view-btn:active,
            .add-to-library-btn:active,
            .back-link:active {
                transform: scale(0.98);
            }
        }

        /* Suport per a dark mode per defecte del sistema */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #0f1117;
                --bg-card: #1a1d28;
                --text-main: #f8fafc;
            }
        }

        /* ANIMACIONS */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ex-card {
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
        }

        .ex-card:nth-child(1) { animation-delay: 0.1s; }
        .ex-card:nth-child(2) { animation-delay: 0.2s; }
        .ex-card:nth-child(3) { animation-delay: 0.3s; }
        .ex-card:nth-child(4) { animation-delay: 0.4s; }
        .ex-card:nth-child(5) { animation-delay: 0.5s; }
        .ex-card:nth-child(6) { animation-delay: 0.6s; }

        /* Correcció per als botons de vista */
        .view-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .view-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>

    <header>
        <a href="index.html" class="back-link">
            <i class="fas fa-chevron-left"></i> TORNAR
        </a>

        <div class="logo-text">
            TRAINLAB <span style="font-weight: 400; color: var(--text-secondary);">BIBLIOTECA</span>
        </div>

        <div class="header-right">
            <a href="biblioteca_personal.html" class="personal-library-btn" id="personalLibraryBtn">
                <i class="fas fa-bookmark"></i> LA MEVA BIBLIOTECA
            </a>
            <div class="user-badge" id="userBadge">
                <i class="fas fa-user-circle"></i>
                <span id="userName">USER</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="controls">
            <div class="search-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" class="search-bar" placeholder="Cerca per títol, categoria o descripció...">
            </div>

            <div class="tags-container">
                <div class="tag active" onclick="selectCategory('Tots', this)">Tots</div>
                <div class="tag" onclick="selectCategory('Escalfament', this)">Escalfament</div>
                <div class="tag" onclick="selectCategory('Posessió', this)">Posessió</div>
                <div class="tag" onclick="selectCategory('Finalització', this)">Finalització</div>
                <div class="tag" onclick="selectCategory('Estratègia', this)">Estratègia</div>
                <div class="tag" onclick="selectCategory('Roda de Passes', this)">Roda de Passes</div>
                <div class="tag" onclick="selectCategory('Defensa', this)">Defensa</div>
                <div class="tag" onclick="selectCategory('Transició', this)">Transició</div>
            </div>
        </div>

        <div id="library-grid">
            <!-- Aquí es renderitzaran les targetes dinàmicament -->
        </div>
    </div>

    <div id="modal">
        <div class="modal-box">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            <div id="pitch-container">
                <div id="lines-layer" class="pitch-lines-layer"></div>
                <canvas id="mainCanvas"></canvas>
                <div id="obj-layer"></div>
            </div>
            <div class="modal-details">
                <h2 id="modal-title"></h2>
                <p id="modal-notes"></p>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            orderBy, 
            onSnapshot,
            addDoc,
            getDocs,
            deleteDoc,
            doc,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { 
            getAuth, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBBaxLhVUekJLCyrtvQaF7t_-1dTERbvAE",
            authDomain: "soccertrainlab.firebaseapp.com",
            projectId: "soccertrainlab",
            storageBucket: "soccertrainlab.firebasestorage.app",
            messagingSenderId: "681099221197",
            appId: "1:681099221197:web:55ae8621c8bc8649057184"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let allExercises = [];
        let currentCategory = 'Tots';
        let currentUser = null;
        let userPersonalExercises = new Set(); // IDs dels exercicis que l'usuari ja té

        // Consulta inicial d'exercicis globals
        const q = query(collection(db, "exercicis"), where("estat", "==", "acceptat"), orderBy("timestamp", "desc"));
        
        onSnapshot(q, (snapshot) => {
            allExercises = snapshot.docs.map(doc => ({ 
                id: doc.id, 
                ...doc.data(),
                globalId: doc.id // Guardem l'ID global per referència
            }));
            applyFilters();
        });

        // Escoltar canvis en l'estat d'autenticació
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            
            if (user) {
                // Mostrar informació de l'usuari
                document.getElementById('userBadge').style.display = 'flex';
                document.getElementById('userName').textContent = user.email.split('@')[0];
                document.getElementById('personalLibraryBtn').style.display = 'flex';
                
                // Carregar exercicis personals de l'usuari
                await loadPersonalExercises(user.uid);
                
                // Aplicar filtres per actualitzar l'estat dels botons
                applyFilters();
            } else {
                // Amagar elements d'usuari
                document.getElementById('userBadge').style.display = 'none';
                document.getElementById('personalLibraryBtn').style.display = 'none';
                userPersonalExercises.clear();
                applyFilters();
            }
        });

        // Carregar exercicis de la biblioteca personal
        async function loadPersonalExercises(userId) {
            userPersonalExercises.clear();
            
            try {
                const personalQuery = query(
                    collection(db, "biblioteca_personal", userId, "exercicis")
                );
                
                const querySnapshot = await getDocs(personalQuery);
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    if (data.globalId) {
                        userPersonalExercises.add(data.globalId);
                    }
                });
                
                console.log(`Carregats ${userPersonalExercises.size} exercicis personals`);
            } catch (error) {
                console.error("Error carregant biblioteca personal:", error);
                showToast("Error carregant la teva biblioteca", "error");
            }
        }

        // Funció per afegir exercici a la biblioteca personal
        async function addToPersonalLibrary(exerciseId, exerciseData) {
            if (!currentUser) {
                showToast("Has d'iniciar sessió per afegir exercicis", "error");
                return false;
            }

            try {
                // Comprovar si ja existeix
                if (userPersonalExercises.has(exerciseId)) {
                    showToast("Aquest exercici ja està a la teva biblioteca", "warning");
                    return false;
                }

                // Afegir a la col·lecció personal de l'usuari
                const personalCollection = collection(db, "biblioteca_personal", currentUser.uid, "exercicis");
                
                await addDoc(personalCollection, {
                    ...exerciseData,
                    globalId: exerciseId, // Referència a l'exercici global
                    addedAt: serverTimestamp(),
                    userId: currentUser.uid
                });

                // Actualitzar estat local
                userPersonalExercises.add(exerciseId);
                
                // Actualitzar UI
                applyFilters();
                
                showToast("Exercici afegit a la teva biblioteca", "success");
                return true;
            } catch (error) {
                console.error("Error afegint exercici a biblioteca personal:", error);
                showToast("Error afegint exercici", "error");
                return false;
            }
        }

        // Funció per mostrar notificacions
        function showToast(message, type = "success") {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Funcions de filtrat i renderitzat
        window.selectCategory = (category, element) => {
            document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
            element.classList.add('active');
            currentCategory = category;
            applyFilters();
        };

        document.getElementById('searchInput').addEventListener('input', applyFilters);

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allExercises.filter(ex => {
                const matchesText = (ex.title || '').toLowerCase().includes(searchTerm) ||
                                   (ex.notes || '').toLowerCase().includes(searchTerm);
                const categoriaEx = ex.tipus || 'Escalfament';
                const matchesCategory = (currentCategory === 'Tots') || (categoriaEx === currentCategory);
                return matchesText && matchesCategory;
            });
            renderGrid(filtered);
        }

        function renderGrid(data) {
            const grid = document.getElementById('library-grid');
            grid.innerHTML = '';
            
            if (data.length === 0) {
                grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align:center; padding: 60px 20px; color:var(--text-secondary); background:var(--bg-card); border-radius:var(--radius); border:1px solid var(--border);">
                    <i class="fas fa-search" style="font-size:3rem; margin-bottom:20px; opacity:0.5;"></i>
                    <h3 style="margin:0 0 10px 0; color:var(--text-main);">No s'han trobat exercicis</h3>
                    <p>Prova amb una altra cerca o selecciona una categoria diferent</p>
                </div>`;
                return;
            }
            
            data.forEach((ex, index) => {
                const isInPersonalLibrary = userPersonalExercises.has(ex.id);
                const card = document.createElement('div');
                card.className = 'ex-card';
                card.style.animationDelay = `${(index % 6) * 0.1}s`;
                card.innerHTML = `
                    <div class="ex-preview">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div class="ex-content">
                        <div class="ex-title">${ex.title || 'Sense títol'}</div>
                        <div class="ex-info">
                            <span class="ex-category">${ex.tipus || 'Escalfament'}</span>
                            <span class="ex-date">${formatDate(ex.timestamp)}</span>
                        </div>
                        <div class="ex-actions">
                            <button class="view-btn" onclick="openExercise(${JSON.stringify(ex).replace(/"/g, '&quot;')})">
                                <i class="fas fa-eye"></i> VEURE
                            </button>
                            ${isInPersonalLibrary ? 
                                `<div class="added-badge">
                                    <i class="fas fa-check-circle"></i> AFEGIT
                                </div>` : 
                                `<button class="add-to-library-btn" onclick="handleAddToLibrary('${ex.id}', this)" ${!currentUser ? 'disabled' : ''}>
                                    <i class="fas fa-plus"></i> AFEGIR A LA MEVA BIBLIOTECA
                                </button>`
                            }
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            try {
                const date = timestamp.seconds ? 
                    new Date(timestamp.seconds * 1000) : 
                    new Date(timestamp);
                return date.toLocaleDateString('ca-ES');
            } catch (e) {
                return '';
            }
        }

        // Funció per manejar l'addició a biblioteca
        window.handleAddToLibrary = async (exerciseId, buttonElement) => {
            if (!currentUser) {
                showToast("Has d'iniciar sessió per afegir exercicis", "error");
                return;
            }
            
            // Trobar l'exercici
            const exercise = allExercises.find(ex => ex.id === exerciseId);
            if (!exercise) return;
            
            // Desactivar botó temporalment
            buttonElement.disabled = true;
            buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AFEGINT...';
            
            // Afegir a biblioteca personal
            const success = await addToPersonalLibrary(exerciseId, exercise);
            
            if (success) {
                // Actualitzar la UI de la targeta
                const card = buttonElement.closest('.ex-card');
                const actionsDiv = card.querySelector('.ex-actions');
                actionsDiv.innerHTML = `
                    <button class="view-btn" onclick="openExercise(${JSON.stringify(exercise).replace(/"/g, '&quot;')})">
                        <i class="fas fa-eye"></i> VEURE
                    </button>
                    <div class="added-badge">
                        <i class="fas fa-check-circle"></i> AFEGIT
                    </div>
                `;
            } else {
                // Reactivar botó si hi ha hagut error
                buttonElement.disabled = false;
                buttonElement.innerHTML = '<i class="fas fa-plus"></i> AFEGIR A LA MEVA BIBLIOTECA';
            }
        };

        // FUNCIÓ REVISADA - IGUAL QUE CREAR_EJERCICIO
        window.openExercise = (ex) => {
            const container = document.getElementById('pitch-container');
            const objLayer = document.getElementById('obj-layer');
            const canvas = document.getElementById('mainCanvas');
            const ctx = canvas.getContext('2d');
            
            document.getElementById('modal-title').innerText = ex.title || "SENSE TÍTOL";
            document.getElementById('modal-notes').innerText = ex.notes || "Sense notes.";
            document.getElementById('modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Configurar aspect ratio igual que crear_ejercicio
            if (ex.isFullPitch !== undefined) {
                container.style.aspectRatio = ex.isFullPitch ? "1.5 / 1" : "1.2 / 1";
            } else {
                container.style.aspectRatio = "1.2 / 1";
            }
            
            // Esperar a que el container tingui dimensions
            setTimeout(() => {
                const W = container.clientWidth; 
                const H = container.clientHeight;
                canvas.width = W; 
                canvas.height = H;
                objLayer.innerHTML = '';
                
                // Renderitzar línies del camp
                renderPitchLines(ex.isFullPitch || false);
                
                // IMPORTANT: Renderitzar paths amb percentatges (igual que crear_ejercicio)
                if(ex.paths && ex.paths.length > 0) {
                    ex.paths.forEach(p => {
                        // Convertir percentatges a píxels
                        const x1 = (p.x1 * W) / 100;
                        const y1 = (p.y1 * H) / 100;
                        const x2 = (p.x2 * W) / 100;
                        const y2 = (p.y2 * H) / 100;
                        const color = p.color || "rgba(255, 255, 255, 0.9)";
                        
                        drawArrow(ctx, x1, y1, x2, y2, p.dash, color);
                    });
                }
                
                // IMPORTANT: Renderitzar objectes amb percentatges (igual que crear_ejercicio)
                if(ex.objects && ex.objects.length > 0) {
                    ex.objects.forEach(o => {
                        const el = document.createElement('div');
                        el.className = 'element';
                        
                        // Percentatges directes (0-100%)
                        el.style.left = o.x + "%"; 
                        el.style.top = o.y + "%";
                        
                        // Aplicar transformació
                        el.style.transform = `translate(-50%, -50%) rotate(${o.rot || 0}deg) scale(${o.scale || 1})`;
                        
                        // Tipus d'objecte (IGUAL QUE CREAR_EJERCICIO)
                        if(o.type && o.type.startsWith('p-')) {
                            const col = o.color || (o.type === 'p-red' ? '#ef4444' : 
                                       o.type === 'p-blue' ? '#3b82f6' : 
                                       o.type === 'p-yellow' ? '#f59e0b' : '#8b5cf6');
                            el.innerHTML = `<div class="player" style="background:${col}">${o.text || ''}</div>`;
                        } 
                        else if(o.type === 'cone') {
                            el.innerHTML = `<div class="cone-obj" style="border-bottom-color:${o.color || '#f59e0b'}"></div>`;
                        } 
                        else if(o.type === 'ball') {
                            el.innerHTML = `<i class="fas fa-futbol" style="color:white; font-size:26px;"></i>`;
                        } 
                        else if(o.type === 'goal') {
                            el.innerHTML = `<div class="goal-visual" style="border-color:${o.color || '#ef4444'}"></div>`;
                        } 
                        else if(o.type === 'ladder') {
                            const height = o.h || "100px";
                            const stepsCount = Math.max(2, Math.floor(parseInt(height) / 25));
                            let stepsHtml = '';
                            for(let i = 0; i <= stepsCount; i++) {
                                stepsHtml += `<div class="ladder-step-line"></div>`;
                            }
                            el.innerHTML = `
                                <div class="ladder-body" style="width:35px; height:${height}; color:${o.color || '#ffffff'}">
                                    ${stepsHtml}
                                </div>
                            `;
                        }
                        else if(o.type === 'valla') {
                            el.innerHTML = `<div style="width:45px; height:8px; border:2px solid ${o.color || '#ffffff'}"></div>`;
                        }
                        
                        objLayer.appendChild(el);
                    });
                }
            }, 100);
        };

        window.closeModal = () => {
            document.getElementById('modal').style.display = 'none';
            document.body.style.overflow = 'auto';
        };

        // Funció per dibuixar fletxes (IGUAL QUE CREAR_EJERCICIO)
        function drawArrow(c, x1, y1, x2, y2, dash, color) {
            c.beginPath(); 
            c.lineWidth = 5; 
            c.strokeStyle = color || "rgba(255, 255, 255, 0.9)";
            if(dash) c.setLineDash([12, 8]); 
            else c.setLineDash([]);
            c.moveTo(x1, y1); 
            c.lineTo(x2, y2); 
            c.stroke();
            
            const angle = Math.atan2(y2-y1, x2-x1);
            c.setLineDash([]); 
            c.beginPath(); 
            c.moveTo(x2, y2);
            c.lineTo(x2-18*Math.cos(angle-0.5), y2-18*Math.sin(angle-0.5));
            c.lineTo(x2-18*Math.cos(angle+0.5), y2-18*Math.sin(angle+0.5));
            c.closePath(); 
            c.fillStyle = color || "rgba(255, 255, 255, 0.9)"; 
            c.fill();
        }

        // Funció per renderitzar línies del camp
        function renderPitchLines(isFull) {
            const linesLayer = document.getElementById('lines-layer');
            const container = document.getElementById('pitch-container');
            linesLayer.innerHTML = '';
            
            if (!isFull) {
                container.style.border = "4px solid rgba(255, 255, 255, 0.9)";
                return; 
            }
            
            container.style.border = "4px solid rgba(255, 255, 255, 0.9)";
            const c = "rgba(34, 197, 94, 0.95)";
            const h = container.clientHeight;
            
            let html = `
                <div class="line-white" style="left:0; top:20%; width:16%; height:60%; border-left:none; box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);"></div>
                <div class="line-white" style="right:0; top:20%; width:16%; height:60%; border-right:none; box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);"></div>
                <div class="line-white" style="left:0; top:35%; width:6%; height:30%; border-left:none; box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);"></div>
                <div class="line-white" style="right:0; top:35%; width:6%; height:30%; border-right:none; box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);"></div>
                <div style="position:absolute; left:50%; top:0; width:4px; height:100%; background:${c}; transform:translateX(-50%); box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);"></div>
                <div style="position:absolute; left:50%; top:50%; width:${h*0.3}px; height:${h*0.3}px; border:4px solid ${c}; border-radius:50%; transform:translate(-50%,-50%); box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);"></div>
                <div style="position:absolute; left:50%; top:50%; width:${h*0.05}px; height:${h*0.05}px; background:${c}; border-radius:50%; transform:translate(-50%,-50%); box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);"></div>
            `;
            linesLayer.innerHTML = html;
        }
    </script>
</body>
</html>